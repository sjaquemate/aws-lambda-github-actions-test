name: AWS Docker Deployment 

on:
  push: 
    branches:
      - main

jobs:
  
  aws-docker-deployment:
    environment: 'aws-credentials'

    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: .
    steps:
    - name: what is github ref?
      run: echo ${{ github.ref }}

    - name: Checkout
      uses: actions/checkout@v2
      with:
        ref: ${{ github.ref }}

    - name: Build container
      run: |
        docker build --tag hello-world:latest .

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-central-1

    - name: Authenticate the Docker CLI to your Amazon ECR registry
      run: |
        aws ecr get-login-password --region eu-central-1 | docker login --username AWS --password-stdin 199287058268.dkr.ecr.eu-central-1.amazonaws.com    
    
    - name: Create a repository (if it doesnt exist) in Amazon ECR using the create-repository command
      run: |
        aws ecr describe-repositories --repository-names hello-world || aws ecr create-repository --repository-name hello-world --image-scanning-configuration scanOnPush=true --image-tag-mutability MUTABLE
    
    - name: Tag your image to match your repository name, and deploy the image to Amazon ECR using the docker push command
      run: |
        docker tag  hello-world:latest 199287058268.dkr.ecr.eu-central-1.amazonaws.com/hello-world:latest
        docker push 199287058268.dkr.ecr.eu-central-1.amazonaws.com/hello-world:latest        
    # - name: Push2ECR
    #   id: ecr
    #   uses: jwalton/gh-ecr-push@v1
    #   with:
    #     access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #     secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #     region: eu-central-1
    #     image: aws-docker-test:latest

    # - name: Update lambda with image
    #   run: aws lambda update-function-code --function-name  --image-uri 863244415814.dkr.ecr.us-east-1.amazonaws.com/iris_classification:latest